var express = require('express');
var controller = require('../controllers/search');
var router = express.Router();
var models = require('../models');
var Result = models.Result;
var Query = models.Query;
var Hidden_Node = models.Hidden_Node;
var Term = models.Term;
var Hidden_To_Result = models.Hidden_To_Result;
var Term_To_Hidden = models.Term_To_Hidden;

var request = require('request');
var q = require('q');
var nn = require('../services/neuralnet');
var results = [{directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=1800%2021st%20Street%20Suite%20100%2C%20Sacramento%2C%20CA%2095811",phoneUrl:null,emailUrl:null,id:12,name:"Sacramento Housing Alliance",externalId:"38",lat:38.5675567,lng:-121.4833534,description:"Sacramento Housing Alliance is a nonprofit coalition that works to ensure that all people in the Sacramento region have safe, decent, accessible and affordable housing in healthy neighborhoods, supported by equitable public policies and practices.",address:"1800 21st Street Suite 100, Sacramento, CA 95811",hours:null,phone:null,rawPhone:null,email:null,url:null,createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>Sacramento Housing Alliance</h4><h5>1800 21st Street Suite 100, Sacramento, CA 95811</h5>",openStatus:false},{directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=2210%20K%20St.%2C%20Sacramento%2C%20CA%2095816",phoneUrl:null,emailUrl:"mailto:example@crla.org",id:14,name:"California Rural Legal Assistance",externalId:"34",lat:38.574489,lng:-121.4773391,description:"Legal center for migrant workers.",address:"2210 K St., Sacramento, CA 95816",hours:null,phone:null,rawPhone:null,email:"example@crla.org",url:"http://crla.org",createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>California Rural Legal Assistance</h4><h5>2210 K St., Sacramento, CA 95816</h5>",openStatus:false},{directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=1831%20P%20St%2C%20Sacramento%2C%20CA%2095811",phoneUrl:null,emailUrl:null,id:16,name:"Sacramento Self-Help Housing",externalId:"44",lat:38.5706671,lng:-121.4841983,description:"Sacramento Self Help Housing reaches out to homeless men and women living in makeshift camps in local communities. Working with police departments less interested in citing the homeless than in offering them suitable alternatives, SSHH is visiting camps in Citrus Heights and Rancho Cordova to meet with the campers, assess their needs and appropriateness for possible programs and services, and whenever possible, refer them to available mental health services, medical care, financial aid, and shelter and housing options.",address:"1831 P St, Sacramento, CA 95811",hours:null,phone:null,rawPhone:null,email:null,url:null,createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>Sacramento Self-Help Housing</h4><h5>1831 P St, Sacramento, CA 95811</h5>",openStatus:false},{directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=1700%2041st%20St.%2C%20Sacramento%2C%20CA%2095819",phoneUrl:null,emailUrl:"mailto:test@example.com",id:17,name:"Sacramento City Hall",externalId:"31",lat:38.562094,lng:-121.455497,description:"The seat of government in Sacramento.",address:"1700 41st St., Sacramento, CA 95819",hours:null,phone:null,rawPhone:null,email:"test@example.com",url:null,createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>Sacramento City Hall</h4><h5>1700 41st St., Sacramento, CA 95819</h5>",openStatus:false},{directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=1900%20K%20St.%2C%20Sacramento%2C%20CA%2095811",phoneUrl:"tel: 916.920.2952",emailUrl:"mailto:example@weaveinc.org",id:19,name:"Weave - Women Escaping",externalId:"35",lat:38.5755858,lng:-121.4814449,description:"A home for victims of human trafficking.",address:"1900 K St., Sacramento, CA 95811",hours:null,phone:"(916) 920-2952",rawPhone:"916.920.2952",email:"example@weaveinc.org",url:"http://weaveinc.org",createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>Weave - Women Escaping</h4><h5>1900 K St., Sacramento, CA 95811</h5>",openStatus:false},{directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=812%2021st%20Street%2C%20Sacramento%2C%20CA%2095811",phoneUrl:"tel: 9163648395",emailUrl:"mailto:info@tpcp.org",id:20,name:"Pathways to Success",externalId:"46",lat:38.578107,lng:-121.4780139,description:"Pathways to Success After Homelessness provides supportive housing and mental health services for those with psychiatric disabilities and long-term or cyclical homelessness. Staff uses a harm reduction â€œwhatever it takesâ€ approach to support members in meeting their desired goals. Families with children are offered culturally diverse supportive services so they can stay together and be part of the community.",address:"812 21st Street, Sacramento, CA 95811",hours:null,phone:"(916) 364-8395",rawPhone:"9163648395",email:"info@tpcp.org",url:null,createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>Pathways to Success</h4><h5>812 21st Street, Sacramento, CA 95811</h5>",openStatus:false},{directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=517%2012th%20St%2C%20Sacramento%2C%20CA%2095814",phoneUrl:"tel: 9165512150",emailUrl:"mailto:example@lsnc.net",id:29,name:"Legal Services of Northern California",externalId:"48",lat:38.584332,lng:-121.488424,description:"Providing legal services to Northern California",address:"517 12th St, Sacramento, CA 95814",hours:null,phone:"(916) 551-2150",rawPhone:"9165512150",email:"example@lsnc.net",url:"http://about.lsnc.net",createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>Legal Services of Northern California</h4><h5>517 12th St, Sacramento, CA 95814</h5>",openStatus:false},{directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=717%20K%20St%2C%20Sacramento%2C%20CA%2095814",phoneUrl:"tel: 916.706.1836",emailUrl:"mailto:example@sacramentofoodbank.org",id:31,name:"Sacramento Food Bank & Family Services",externalId:"24",lat:38.580237,lng:-121.4970604,description:"The Housing Assistance Council (HAC) has been helping local organizations build affordable homes in rural America since 1971. HAC assists in the development of both single- and multi-family homes and promotes homeownership for working low-income rural families through a self-help, \"sweatequity\" construction method by emphasizing local solutions, empowerment of the poor, reduced dependence, and self-help strategies. HAC offers services to public, nonprofit, and private organizations throughout the rural United States and maintains a special focus on high-need groups and regions, such as: Indian country, the Mississippi Delta, farmworkers, the Southwest border colonias, and Appalachia.",address:"717 K St, Sacramento, CA 95814",hours:null,phone:"(916) 706-1836",rawPhone:"916.706.1836",email:"example@sacramentofoodbank.org",url:null,createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>Sacramento Food Bank & Family Services</h4><h5>717 K St, Sacramento, CA 95814</h5>",openStatus:false},{directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=650%20Capitol%20Mall%2C%20Sacramento%2C%20CA%2095814",phoneUrl:"tel: 9164985220",emailUrl:"mailto:example@ushud.gov",id:32,name:"US Housing & Urban Development Department",externalId:"30",lat:38.577761,lng:-121.499971,description:"Helping Americans find housing.",address:"650 Capitol Mall, Sacramento, CA 95814",hours:null,phone:"(916) 498-5220",rawPhone:"9164985220",email:"example@ushud.gov",url:"http://hud.gov",createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>US Housing & Urban Development Department</h4><h5>650 Capitol Mall, Sacramento, CA 95814</h5>",openStatus:false},{directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=1111%20Howe%20Avenue%20Suite%20390%2C%20Sacramento%2C%20CA%2095825",phoneUrl:null,emailUrl:null,id:33,name:"Sacramento Veteran's Center",externalId:"32",lat:38.586175,lng:-121.416099,description:"Service for combat veterans. Free counseling, Tai Chi, Meditation, Yoga, and more for vets, spouses, and children.",address:"1111 Howe Avenue Suite 390, Sacramento, CA 95825",hours:null,phone:null,rawPhone:null,email:null,url:"http://www.va.gov/directory/guide/facility.asp?ID=521",createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>Sacramento Veteran's Center</h4><h5>1111 Howe Avenue Suite 390, Sacramento, CA 95825</h5>",openStatus:false},{directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=4410%20Power%20Inn%20Road%2C%20Sacramento%2C%20CA%2095826",phoneUrl:"tel: 916-453-1482",emailUrl:null,id:35,name:"St. John's Shelter for Women and Children",externalId:"33",lat:38.5349118,lng:-121.4092183,description:"St. John's Shelter for Women and Children is the largest 120-day shelter in Sacramento County, and the only one focused exclusively on homeless mothers and their children. But our shelter is only part of what we do. While living in our program, you receive mental health services, educational assistance (including GED tutoring and testing) and on-the-job employment training. While you're in classes, your children attend our preschool or after-school program. St. John's offers a true chance at independence. Note that these services are only available to residents. To add your name to our waiting list, please contact us at (916) 453-1482.",address:"4410 Power Inn Road, Sacramento, CA 95826",hours:null,phone:"(916) 453-1482",rawPhone:"916-453-1482",email:null,url:"http://saintjohnsprogram.org/",createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>St. John's Shelter for Women and Children</h4><h5>4410 Power Inn Road, Sacramento, CA 95826</h5>",openStatus:false}];
var query = {"bounds":"38.60023699364402,-121.5479278564453,38.52829312835967,-121.3941192626953","center":"38.5643,-121.4711","category":"Homeless,Cash","lat_lng":"38.5643,-121.4711","per_page":100,"radius":50};
var query2 = {"bounds":"38.60023699364402,-121.5479278564453,38.52829312835967,-121.3941192626953","center":"38.5643,-121.4711","category":"Homeless","lat_lng":"38.5643,-121.4711","per_page":100,"radius":50};
var query3 = {"bounds":"38.60023699364402,-121.5479278564453,38.52829312835967,-121.3941192626953","center":"38.5643,-121.4711","category":"Cash","lat_lng":"38.5643,-121.4711","per_page":100,"radius":50};
var selected = {directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=1900%20K%20St.%2C%20Sacramento%2C%20CA%2095811",phoneUrl:"tel: 916.920.2952",emailUrl:"mailto:example@weaveinc.org",id:19,name:"Weave - Women Escaping",externalId:"35",lat:38.5755858,lng:-121.4814449,description:"A home for victims of human trafficking.",address:"1900 K St., Sacramento, CA 95811",hours:null,phone:"(916) 920-2952",rawPhone:"916.920.2952",email:"example@weaveinc.org",url:"http://weaveinc.org",createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>Weave - Women Escaping</h4><h5>1900 K St., Sacramento, CA 95811</h5>",openStatus:false};
var selected2 = {directionsUrl:"http://maps.google.com/maps?saddr=Current+Location&daddr=1800%2021st%20Street%20Suite%20100%2C%20Sacramento%2C%20CA%2095811",phoneUrl:null,emailUrl:null,id:12,name:"Sacramento Housing Alliance",externalId:"38",lat:38.5675567,lng:-121.4833534,description:"Sacramento Housing Alliance is a nonprofit coalition that works to ensure that all people in the Sacramento region have safe, decent, accessible and affordable housing in healthy neighborhoods, supported by equitable public policies and practices.",address:"1800 21st Street Suite 100, Sacramento, CA 95811",hours:null,phone:null,rawPhone:null,email:null,url:null,createdAt:"2014-11-19T21:42:25.000Z",updatedAt:"2014-11-19T21:42:25.000Z",popup:"<h4>Sacramento Housing Alliance</h4><h5>1800 21st Street Suite 100, Sacramento, CA 95811</h5>",openStatus:false};


var realResults = [{"directionsUrl":"http://maps.google.com/maps?saddr=Current+Location&daddr=undefined%2C%20San%20Mateo%2C%20CA%20undefined","phoneUrl":"tel: 650 403-4300,4385","emailUrl":null,"id":91,"name":"Second Career Employment Program","lat":37.5639843,"lng":-122.3257992,"description":"Provides training and job placement to eligible people age 55 or over who meet certain income qualifications. An income of 125% of poverty level or less is required for subsidized employment and training. (No income requirements for job matchup program.) If a person seems likely to be qualified after a preliminary phone call or visit, he or she must complete an application at this office. Staff will locate appropriate placements for applicants, provide orientation and on-the-job training and assist with finding a job outside the program. Any county resident, regardless of income, age 55 or over has access to the program, job developers and the job bank. Also provides referrals to classroom training. Formerly known as Family Service Agency of San Mateo County, Senior Employment Services.","address":"undefined, San Mateo, CA undefined","phone":"650 403-4300 4385","rawPhone":"650 403-4300,4385","email":null,"url":null,"updatedAt":"2014-11-23T06:26:59.000Z","createdAt":"2014-11-23T06:27:00.000Z","popup":"<h4>Second Career Employment Program</h4><h5>undefined, San Mateo, CA undefined</h5>","openStatus":false},{"directionsUrl":"http://maps.google.com/maps?saddr=Current+Location&daddr=undefined%2C%20San%20Mateo%2C%20CA%20undefined","phoneUrl":"tel: 650 403-4300","emailUrl":null,"id":92,"name":"Senior Peer Counseling","lat":37.5639843,"lng":-122.3257992,"description":"Offers supportive counseling services to San Mateo County residents age 55 or over. Volunteer counselors are selected and professionally trained to help their peers face the challenges and concerns of growing older. Training provides topics that include understanding depression, cultural competence, sexuality, community resources, and other subjects that are relevant to working with older adults. After completion of training, weekly supervision groups are provided for the volunteer senior peer counselors, as well as quarterly in-service training seminars. Peer counseling services are provided in English, Spanish, Chinese (Cantonese and Mandarin), Tagalog, and to the lesbian, gay, bisexual, transgender older adult community. Formerly known as Family Service Agency of San Mateo County, Senior Peer Counseling.","address":"undefined, San Mateo, CA undefined","phone":"650 403-4300","rawPhone":"650 403-4300","email":null,"url":null,"updatedAt":"2014-11-23T06:27:00.000Z","createdAt":"2014-11-23T06:27:00.000Z","popup":"<h4>Senior Peer Counseling</h4><h5>undefined, San Mateo, CA undefined</h5>","openStatus":false},{"directionsUrl":"http://maps.google.com/maps?saddr=Current+Location&daddr=undefined%2C%20San%20Mateo%2C%20CA%20undefined","phoneUrl":"tel: 650 403-4300,4500","emailUrl":null,"id":93,"name":"Family Visitation Center","lat":37.5639843,"lng":-122.3257992,"description":"Provides supervised visitation services and a neutral site for parents to carry out supervised exchanges of children in a safe manner. Therapeutic visitation and other counseling services available. Kids in the Middle is an education class for separating or divorcing parents. The goal is to enable parents to focus on their children's needs while the family is going through separation, divorce or other transition. The class explores the psychological aspects of divorce and its impact on children, builds effective communication techniques and points out areas in which outside help may be indicated. The fee is $50 for working parents, $15 for unemployed people. Classes are scheduled on Saturdays and Sundays and held at various sites throughout the county. Call 650-403-4300 ext. 4500 to register. Formerly known as Family Service Agency of San Mateo County, Family Visitation Center.","address":"undefined, San Mateo, CA undefined","phone":"650 403-4300 4500","rawPhone":"650 403-4300,4500","email":null,"url":null,"updatedAt":"2014-11-23T06:27:00.000Z","createdAt":"2014-11-23T06:27:00.000Z","popup":"<h4>Family Visitation Center</h4><h5>undefined, San Mateo, CA undefined</h5>","openStatus":false},{"directionsUrl":"http://maps.google.com/maps?saddr=Current+Location&daddr=undefined%2C%20San%20Mateo%2C%20CA%20undefined","phoneUrl":"tel: 650 403-4300,4100","emailUrl":null,"id":94,"name":"Economic Self - Sufficiency Program","lat":37.5639843,"lng":-122.3257992,"description":"Provides fixed 8% short term loans to eligible applicants for the purchase of a reliable, used autmobile. Loans are up to $6,000 over 2 1/2 years (30 months). Funds must go towards the entire purchase of the automobile. Peninsula Family Service originates loans and collaborates with commercial partner banks to service the loans, helping clients build credit histories. Formerly known as Family Service Agency of San Mateo County, Ways to Work Family Loan Program.","address":"undefined, San Mateo, CA undefined","phone":"650 403-4300 4100","rawPhone":"650 403-4300,4100","email":null,"url":null,"updatedAt":"2014-11-23T06:27:00.000Z","createdAt":"2014-11-23T06:27:00.000Z","popup":"<h4>Economic Self - Sufficiency Program</h4><h5>undefined, San Mateo, CA undefined</h5>","openStatus":false},{"directionsUrl":"http://maps.google.com/maps?saddr=Current+Location&daddr=undefined%2C%20San%20Mateo%2C%20CA%20undefined","phoneUrl":"tel: 650 578-0400","emailUrl":null,"id":95,"name":"San Mateo Free Medical Clinic","lat":37.5326941,"lng":-122.2931236,"description":"Provides free medical and dental care to those in need. Offers basic medical care for adults.","address":"undefined, San Mateo, CA undefined","phone":"650 578-0400","rawPhone":"650 578-0400","email":null,"url":null,"updatedAt":"2014-11-23T06:27:00.000Z","createdAt":"2014-11-23T06:27:00.000Z","popup":"<h4>San Mateo Free Medical Clinic</h4><h5>undefined, San Mateo, CA undefined</h5>","openStatus":false},{"directionsUrl":"http://maps.google.com/maps?saddr=Current+Location&daddr=undefined%2C%20Belmont%2C%20CA%20undefined","phoneUrl":"tel: 7035551212,1223","emailUrl":null,"id":96,"name":"Admin Test Location","lat":37.5291938,"lng":-122.2871612,"description":"This is a description","address":"undefined, Belmont, CA undefined","phone":"(703) 555-1212 1223","rawPhone":"7035551212,1223","email":null,"url":null,"updatedAt":"2014-11-23T06:27:00.000Z","createdAt":"2014-11-23T06:27:00.000Z","popup":"<h4>Admin Test Location</h4><h5>undefined, Belmont, CA undefined</h5>","openStatus":false},{"directionsUrl":"http://maps.google.com/maps?saddr=Current+Location&daddr=undefined%2C%20Redwood%20City%2C%20CA%20undefined","phoneUrl":"tel: 650 780-5740","emailUrl":null,"id":97,"name":"Redwood Shores Branch","lat":37.5304228,"lng":-122.2586432,"description":"Provides general reading materials, including large-type books, videos, music cassettes and CDs, and books on tape. Offers children's programs and a Summer Reading Club. Meeting room is available to nonprofit groups. Participates in the Peninsula Library System.","address":"undefined, Redwood City, CA undefined","phone":"650 780-5740","rawPhone":"650 780-5740","email":null,"url":null,"updatedAt":"2014-11-23T06:27:00.000Z","createdAt":"2014-11-23T06:27:00.000Z","popup":"<h4>Redwood Shores Branch</h4><h5>undefined, Redwood City, CA undefined</h5>","openStatus":false}];
var realSelected = {"directionsUrl":"http://maps.google.com/maps?saddr=Current+Location&daddr=undefined%2C%20San%20Mateo%2C%20CA%20undefined","phoneUrl":"tel: 650 403-4300,4100","emailUrl":null,"id":94,"name":"Economic Self - Sufficiency Program","lat":37.5639843,"lng":-122.3257992,"description":"Provides fixed 8% short term loans to eligible applicants for the purchase of a reliable, used autmobile. Loans are up to $6,000 over 2 1/2 years (30 months). Funds must go towards the entire purchase of the automobile. Peninsula Family Service originates loans and collaborates with commercial partner banks to service the loans, helping clients build credit histories. Formerly known as Family Service Agency of San Mateo County, Ways to Work Family Loan Program.","address":"undefined, San Mateo, CA undefined","phone":"650 403-4300 4100","rawPhone":"650 403-4300,4100","email":null,"url":null,"updatedAt":"2014-11-23T06:27:00.000Z","createdAt":"2014-11-23T06:27:00.000Z","popup":"<h4>Economic Self - Sufficiency Program</h4><h5>undefined, San Mateo, CA undefined</h5>","openStatus":false};
var realQuery = {"bounds":"37.59056721656451,-122.40863800048828,37.51762330748539,-122.25482940673828","center":"37.55413820908797,-122.33177661895752","lat_lng":"37.55413820908797,-122.33177661895752","per_page":100,"radius":50};

var neuralNet = new nn(Hidden_Node, Hidden_To_Result, Term, Term_To_Hidden, Result, q);


/* GET search results */
router.get('/', function(req, res) {
  new controller(req, res, Result, Query, request, q, neuralNet).render();
});

router.get('/test', function(req, res) {
  neuralNet.rankResult(query, results).then(function (data) {
    console.log(results.length);
    console.log(data.length);
    neuralNet.trainQuery(query, results, selected, 1).then(
      function () {
        neuralNet.trainQuery(query2, results, selected2, 1).then(function () {
          neuralNet.trainQuery(query3, results, selected2, 1);
        });
      }
    );
    res.json(data);
    /*
    neuralNet.rankResult(query, results).then(function (data2) {
      res.json(data2);
    })
    */
  });
});

router.get('/insertResults', function (req, res) {
  var p = [];
  results.forEach(function (result) {
    p.push(Result.create(result));
  });
  q.all(p).then(function(){res.json({all:"done"});});
});
router.get('/neural', function (req, res) {
  neuralNet.rankResult(query3,results).then(function (ranked) {
    res.json(ranked);
  });
});

router.get('/neural2', function (req, res) {
  neuralNet.rankResult(query2,results).then(function (ranked) {
    res.json(ranked);
  });
});

router.get('/neural/train1', function (req, res) {
  neuralNet.trainQuery(query3, results, selected2, 1).then(function(){
    res.json("done");
  }, function () {
    res.json("Done, but rejected.");
  });
});


router.get('/neural/train2', function (req, res) {
  neuralNet.trainQuery(query2, results, selected, 1).then(function(){
    res.json("done");
  }, function (){
    res.json("done, but rejected");
  });
});

router.get('/trainreal', function (req, res) {
  neuralNet.trainQuery(realQuery, realResults, realSelected, 1).then(function () {
    res.json('done');
  }, function () {
    res.json('done, but rejected');
  });
});
module.exports = router;
